<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Domain Verifier</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <style>
      .progress {
        height: 30px;
      }
      .table-log {
        max-height: 200px;
        overflow-y: auto;
        justify-content: center;
      }
      .output-log-row {
        max-height: 480px; /* 20 lines, approx 24px per line */
        min-height: 240px;
        overflow-y: auto;
        background: #f8f9fa;
        border-radius: 5px;
        padding: 8px 12px;
        font-family: monospace;
        font-size: 0.95em;
        scrollbar-width: thin;
        scrollbar-color: #888 #23272b;
      }
      .output-log-row::-webkit-scrollbar {
        width: 8px;
      }
      .output-log-row::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      .output-log-row::-webkit-scrollbar-track {
        background: #23272b;
      }
      body.bg-dark,
      body.bg-dark .container,
      body.bg-dark .table,
      body.bg-dark .form-control,
      body.bg-dark .output-log-row {
        background-color: #23272b !important;
        color: #f8f9fa !important;
      }
      .table.bg-dark,
      .table.bg-dark th,
      .table.bg-dark td {
        background-color: #23272b !important;
        color: #f8f9fa !important;
      }
      .form-control.bg-dark {
        background-color: #23272b !important;
        color: #f8f9fa !important;
        border-color: #444;
      }
      .btn-darkmode {
        position: absolute;
        top: 20px;
        right: 30px;
        z-index: 10;
      }
    </style>
  </head>
  <body class="bg-dark">
    <div class="container py-5">
      <h2 class="mb-4">Domain Verifier</h2>
      <div class="alert alert-info" style="font-size: 1.05em">
        <strong>Instructions:</strong><br />
        1. Upload your domain list as a CSV file with a header named
        <b>Domain</b>.<br />
        2. Indicate how many times you want the domain list to be processed.<br />
        3. Click <b>Start</b> to begin processing. You can stop anytime with the
        <b>Stop</b> button.<br />
        4. When processing is complete, click <b>Download Result</b> to download
        your processed file.
      </div>

      <form id="uploadForm" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="file" class="form-label">Upload CSV file</label>
          <input
            class="form-control bg-dark"
            type="file"
            id="file"
            name="file"
            accept=".csv"
            required
          />
        </div>
        <div class="mb-3">
          <label for="retries" class="form-label"
            >Number of verification retries <i> (Default Value: 4)</i></label
          >
          <input
            class="form-control"
            type="number"
            id="retries"
            name="retries"
            min="1"
            value="4"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary w-100 mb-2" id="startBtn">
          Start
        </button>
        <div class="row mb-2">
          <div class="col-6 pe-1">
            <button
              type="button"
              class="btn btn-danger w-100"
              id="stopBtn"
              style="opacity: 0.5"
            >
              Stop
            </button>
          </div>
          <div class="col-6 ps-1">
            <a
              href="#"
              class="btn btn-success w-100"
              id="downloadBtn"
              style="opacity: 0.5; display: block"
              disabled
            >
              Download Result
            </a>
          </div>
        </div>
      </form>
      <div class="my-4">
        <div class="d-flex align-items-center mb-1">
          <label class="form-label mb-0 me-3">Progress</label>
          <span
            id="passInfo"
            class="badge bg-info text-dark"
            style="font-size: 1em; display: none"
            >PASS 1</span
          >
        </div>
        <div class="progress">
          <div
            id="progressBar"
            class="progress-bar"
            role="progressbar"
            style="width: 0%"
          >
            0%
          </div>
        </div>
      </div>
      <div class="my-4">
        <h5>Processed Files Log</h5>
        <div class="table-log">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Filename</th>
                <th>Date</th>
                <th>ETA</th>
                <th>Total Websites</th>
                <th>Reachable</th>
                <th>Download</th>
              </tr>
            </thead>
            <tbody id="logTable"></tbody>
          </table>
        </div>
      </div>
      <div class="my-4">
        <h5>Process Output Log</h5>
        <div class="output-log-row" id="outputLog"></div>
        <button
          class="btn btn-secondary btn-sm mt-2 w-100"
          id="clearLogBtn"
          type="button"
        >
          Clear Log
        </button>
      </div>
      <button
        class="btn btn-outline-light btn-darkmode"
        id="toggleDark"
        type="button"
      >
        ðŸŒ™
      </button>
    </div>
    <script>
      // Prevent log from being repopulated after stop
      let logClearedByStop = false;
      let stopRequested = false;
      let totalPasses = 4; // Default value
      function updateProgress() {
        if (stopRequested) {
          if (!logClearedByStop) {
            document.getElementById("outputLog").innerHTML = "";
            logClearedByStop = true;
          }
          // Hide pass info when stopped
          document.getElementById("passInfo").style.display = "none";
          return;
        }
        logClearedByStop = false;
        fetch("/progress")
          .then((r) => r.json())
          .then((data) => {
            let bar = document.getElementById("progressBar");
            bar.style.width = data.percent + "%";
            bar.textContent = data.percent + "%";
            let outputLog = document.getElementById("outputLog");
            // Show only the last 20 lines
            let lastLines = data.log.slice(-20);
            outputLog.innerHTML = lastLines
              .map((line) => `<div>${line}</div>`)
              .join("");
            outputLog.scrollTop = outputLog.scrollHeight;
            // --- PASS info ---
            let passInfo = document.getElementById("passInfo");
            let passNum = null;
            // Look for pass info in the log (e.g., 'Pass 1', 'Pass 2', 'Verifying... (Pass 1: HEAD)', etc.)
            for (let i = lastLines.length - 1; i >= 0; i--) {
              let line = lastLines[i];
              let m = line.match(/Pass (\d+)/i);
              if (m) {
                passNum = m[1];
                break;
              }
              // Also match 'Verifying... (Pass 1: HEAD)' or 'Verifying... (Pass 2: GET)'
              let m2 = line.match(/Verifying.*\(Pass (\d+)/i);
              if (m2) {
                passNum = m2[1];
                break;
              }
            }
            if (passNum) {
              passInfo.textContent = `PASS ${passNum}`;
              passInfo.style.display = "inline-block";
            } else {
              passInfo.style.display = "none";
            }
            // --- End PASS info ---
            let completeNote = document.getElementById("completeNote");
            if (data.percent === 100) {
              document.getElementById("outputLog").innerHTML = "";
              document.getElementById("downloadBtn").style.display =
                "inline-block";
              let countdown = 5;
              if (!completeNote) {
                completeNote = document.createElement("div");
                completeNote.id = "completeNote";
                completeNote.className = "text-success mt-2 text-center";
                completeNote.textContent = `Verification is Complete! Refreshing in ${countdown}..`;
                document.querySelector(".progress").after(completeNote);
              }
              // Countdown update
              let intervalId = setInterval(() => {
                countdown--;
                if (completeNote) {
                  completeNote.textContent = `Verification is Complete! Refreshing in ${countdown}..`;
                }
                if (countdown <= 0) {
                  clearInterval(intervalId);
                  window.location.reload();
                }
              }, 1000);
            } else if (completeNote) {
              completeNote.remove();
            }
          });
      }

      // Fetch all files from the "all" folder for the log table
      function updateLogTable() {
        fetch("/log?folder=all&ts=" + Date.now()) // prevent caching
          .then((r) => r.json())
          .then((files) => {
            let table = document.getElementById("logTable");
            table.innerHTML = "";
            if (files.length > 0) {
              files.forEach((f) => {
                let row = document.createElement("tr");
                row.innerHTML = `
                  <td>${f.filename}</td>
                  <td>${f.date}</td>
                  <td>${f.eta}</td>
                  <td>${f.total}</td>
                  <td>${f.good}</td>
                  <td><a href="/download?file=${encodeURIComponent(
                    f.filename
                  )}&folder=all" class="btn btn-sm btn-outline-success">Download</a></td>
                `;
                table.appendChild(row);
              });
            }
          });
      }

      document.getElementById("toggleDark").onclick = function () {
        document.body.classList.toggle("bg-dark");
        document
          .querySelectorAll(".form-control")
          .forEach((el) => el.classList.toggle("bg-dark"));
        document
          .querySelectorAll(".table")
          .forEach((el) => el.classList.toggle("bg-dark"));
      };

      document.getElementById("stopBtn").onclick = function (e) {
        e.preventDefault();
        stopRequested = true;
        fetch("/stop", { method: "POST" }).then(() => {
          // Reset UI to initial state
          document.getElementById("progressBar").style.width = "0%";
          document.getElementById("progressBar").textContent = "0%";
          document.getElementById("outputLog").innerHTML = "";
          // Clear backend log as well
          fetch("/clear_log", { method: "POST" }).then(() => {
            // Double clear to ensure nothing is displayed
            document.getElementById("outputLog").innerHTML = "";
          });
          document
            .getElementById("downloadBtn")
            .setAttribute("disabled", "disabled");
          document.getElementById("downloadBtn").style.opacity = 0.5;
          this.setAttribute("disabled", "disabled");
          this.style.opacity = 0.5;
          this.textContent = "Stop";
          // Optionally reset file input and retries
          document.getElementById("uploadForm").reset();
          totalPasses = 4; // Reset to default
        });
      };

      document.getElementById("uploadForm").onsubmit = function (e) {
        e.preventDefault();
        let fileInput = document.getElementById("file");
        let downloadBtn = document.getElementById("downloadBtn");
        let stopBtn = document.getElementById("stopBtn");
        let retriesInput = document.getElementById("retries");
        totalPasses = parseInt(retriesInput.value) || 4;
        if (!fileInput.files.length) {
          fileInput.classList.add("is-invalid");
          fileInput.focus();
          return;
        } else {
          fileInput.classList.remove("is-invalid");
        }
        downloadBtn.setAttribute("disabled", "disabled");
        downloadBtn.style.opacity = 1;
        stopBtn.removeAttribute("disabled");
        stopBtn.style.opacity = 1;
        stopBtn.textContent = "Stop";
        stopRequested = false;
        let formData = new FormData(this);
        fetch("/upload", { method: "POST", body: formData }).then(() => {
          let logClearedForThisRun = false;
          let interval = setInterval(() => {
            // Only clear the log once at the start of a new process
            if (
              !logClearedForThisRun &&
              document.getElementById("progressBar").textContent === "0%"
            ) {
              document.getElementById("outputLog").innerHTML = "";
              logClearedForThisRun = true;
            }
            updateProgress();
            if (
              document.getElementById("progressBar").textContent === "100%" ||
              stopRequested
            ) {
              clearInterval(interval);
              updateLogTable();
              downloadBtn.removeAttribute("disabled");
              downloadBtn.style.opacity = 1;
              stopBtn.setAttribute("disabled", "disabled");
              stopBtn.style.opacity = 0.5;
              stopBtn.textContent = "Stop";
              // Clear the file input so a new file can be selected
              document.getElementById("file").value = "";
            }
          }, 1000);
        });
      };
      document.getElementById("downloadBtn").onclick = function (e) {
        // Download button logic is handled elsewhere; no need for an if statement here.
        // If you want to add custom logic, do so here.
      };
    </script>
  </body>
</html>
